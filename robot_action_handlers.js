import * as THREE from 'three';
import { policy } from './policy.js';


const action_dt = 0.02;


class RobotActionHandler {
	constructor() {
		this.is_initialized = false;
	}

	init(model) {
		this.complete_nominal_joint_position = new Float32Array(model.key_qpos);
		this.nominal_joint_positions = this.complete_nominal_joint_position.filter((_, i) => this.joint_mask_qpos.includes(i));

		this.nr_action_joints = this.joint_mask_qpos.length;
		this.nr_feet = this.foot_indices.length;
		this.previous_action = new Float32Array(this.nr_action_joints);
		this.feet_contact_times = new Float32Array(this.nr_feet);

		this.is_initialized = true;
	}

	reset() {
		this.previous_action.fill(0.0);
		this.feet_contact_times.fill(0.0);
	}

	action(simulation, model, x_goal_velocity, y_goal_velocity, yaw_goal_velocity) {
		let original_qpos = simulation.qpos;
		let original_qvel = simulation.qvel;
		let qpos = original_qpos.filter((_, i) => this.joint_mask_qpos.includes(i));
		let qvel = original_qvel.filter((_, i) => this.joint_mask_qvel.includes(i));
		let dynamic_joint_observations = []
		for (let i = 0; i < this.nr_action_joints; i++) {
			dynamic_joint_observations.push([
				(qpos[i] - this.nominal_joint_positions[i]) / 4.6,
				qvel[i] / 35.0,
				this.previous_action[i] / 10.0
			]);
		}
		let dynamic_joint_observations_tf = tf.tensor2d(dynamic_joint_observations, [model.nu, 3]);

		let z_pos_all_geoms = simulation.geom_xpos.filter((_, i) => i % 3 == 2)
		let foot_z_pos = this.foot_indices.map(i => z_pos_all_geoms[i]);
		let foot_contacts = foot_z_pos.map(z => z < this.foot_contact_threshold ? 1.0 : 0.0);
		this.feet_contact_times = this.feet_contact_times.map((t, i) => foot_contacts[i] == 1 ? t + action_dt : 0.0);
		let dynamic_foot_observations = [];
		for (let i = 0; i < this.nr_feet; i++) {
			dynamic_foot_observations.push([
				(foot_contacts[i] / 0.5) - 1.0,
				Math.min(Math.max((this.feet_contact_times[i] / (5.0 / 2)) - 1.0, -1.0), 1.0)
			]);
		}
		let dynamic_foot_observations_tf = tf.tensor2d(dynamic_foot_observations, [4, 2]);

		let quat = new THREE.Quaternion(original_qpos[4], original_qpos[5], original_qpos[6], original_qpos[3]);
		let inverse_quat = quat.invert();
		let trunk_angular_velocity = new Float32Array([original_qvel[3], original_qvel[4], original_qvel[5]]);
		for (let i = 0; i < 3; i++) {
			trunk_angular_velocity[i] = Math.min(Math.max(trunk_angular_velocity[i] / 50.0, -1.0), 1.0);
		}
		let goal_velocity = new Float32Array([x_goal_velocity, y_goal_velocity, yaw_goal_velocity]);
		let gravity_vector = new THREE.Vector3(0.0, 0.0, -1.0);
		let projected_gravity_vector_three = gravity_vector.applyQuaternion(inverse_quat);
		let projected_gravity_vector = new Float32Array([projected_gravity_vector_three.x, projected_gravity_vector_three.y, projected_gravity_vector_three.z]);
		let general_state_tf = tf.tensor1d([
			...trunk_angular_velocity,
			...goal_velocity,
			...projected_gravity_vector,
			...this.general_policy_state_second_part
		]);

		let nn_action = policy(this.dynamic_joint_description, dynamic_joint_observations_tf, this.dynamic_foot_description, dynamic_foot_observations_tf, general_state_tf).dataSync();

		for (let i = 0; i < this.nr_action_joints; i++) {
			let scaled_action = this.scaling_factor * nn_action[i];
			let target_joint_pos = this.nominal_joint_positions[i] + scaled_action;
			let torque = this.p_gain * (target_joint_pos - qpos[i]) - this.d_gain * qvel[i];
			simulation.ctrl[i] = torque;
			this.previous_action[i] = nn_action[i];
		}
	}
}


class UnitreeA1 extends RobotActionHandler {
	constructor() {
		super();
		this.dynamic_joint_description = tf.tensor2d(
			[[0.6946284174919128, -0.21824967861175537, 0.3838578462600708, 1.0, 0.0, 0.0, 0.0, -0.021739130839705467, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.17453283071517944, 0.17453283071517944, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [0.6946284174919128, -0.6096015572547913, 0.41939613223075867, 0.0, -0.9950041770935059, 0.0998334139585495, 0.0, -0.17391304671764374, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.9106065034866333, 0.2276521772146225, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [0.2660880982875824, -0.6739331483840942, -0.1609022319316864, 0.0, -0.9950041770935059, 0.0998334139585495, -1.0, 0.32608696818351746, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, 0.19919522106647491, 0.5862021446228027, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [0.6946284174919128, 0.21645677089691162, 0.3838578462600708, 1.0, 0.0, 0.0, 0.0, 0.021739130839705467, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.17453283071517944, 0.17453283071517944, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [0.6946284174919128, 0.6078086495399475, 0.41939613223075867, 0.0, 0.9950041770935059, 0.0998334139585495, 0.0, 0.17391304671764374, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.2276521772146225, 0.9106065034866333, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [0.2660880982875824, 0.6721402406692505, -0.1609022319316864, 0.0, 0.9950041770935059, 0.0998334139585495, -1.0, -0.32608696818351746, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.5862021446228027, -0.19919522106647491, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.39859259128570557, -0.21824967861175537, 0.3838578462600708, -1.0, 0.0, 0.0, 0.0, 0.021739130839705467, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.17453283071517944, 0.17453283071517944, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.39859259128570557, -0.6096015572547913, 0.41939613223075867, 0.0, -0.9950041770935059, 0.0998334139585495, 0.0, -0.21739129722118378, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.9106065034866333, 0.2276521772146225, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.9012777209281921, -0.6594913005828857, -0.030630452558398247, 0.0, -0.9950041770935059, 0.0998334139585495, -1.0, 0.32608696818351746, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, 0.19919522106647491, 0.5862021446228027, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.39859259128570557, 0.21645677089691162, 0.3838578462600708, -1.0, 0.0, 0.0, 0.0, -0.021739130839705467, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.17453283071517944, 0.17453283071517944, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.39859259128570557, 0.6078086495399475, 0.41939613223075867, 0.0, 0.9950041770935059, 0.0998334139585495, 0.0, 0.21739129722118378, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.2276521772146225, 0.9106065034866333, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.9012777209281921, 0.657698392868042, -0.030630452558398247, 0.0, 0.9950041770935059, 0.0998334139585495, -1.0, -0.32608696818351746, -0.9330000281333923, 0.20000000298023224, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.5862021446228027, -0.19919522106647491, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783]],
			[12, 23]
		);
		this.dynamic_foot_description = tf.tensor2d(
			[[0.6509363651275635, -0.7445561289787292, -0.7979517579078674, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [0.6509363651275635, 0.7427632212638855, -0.7979517579078674, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.6148743629455566, -0.7405243515968323, -0.7615832686424255, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783], [-0.6148743629455566, 0.7387314438819885, -0.7615832686424255, -0.6000000238418579, -0.5, -0.375, -0.8534941077232361, -0.33041900396347046, -0.567524254322052, -0.5221588611602783]],
			[4, 10]
		);
		this.general_policy_state_second_part = new Float32Array(
			[-0.6, -0.5, -0.375, -0.8534941176470588, -0.33041901219618564, -0.5675242453164081, -0.5221588713958225],
		);
		this.p_gain = 20.0;
		this.d_gain = 0.5;
		this.scaling_factor = 0.25;
		this.joint_mask_qpos = new Float32Array([7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18])
		this.joint_mask_qvel = new Float32Array([6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17])
		this.foot_indices = [19, 29, 39, 49];
		this.foot_contact_threshold = 0.015;
	}
}

class UnitreeGo1 extends RobotActionHandler {
	constructor() {
		super();
		this.dynamic_joint_description = tf.tensor2d(
			[[0.6857365369796753, -0.21990728378295898, 0.4069512188434601, 1.0, 0.0, 0.0, 0.0, -0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -0.800000011920929, -0.8999999761581421, -1.0, -0.6666666865348816, -0.18760868906974792, 0.18760868906974792, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [0.6857365369796753, -0.5964191555976868, 0.4405384063720703, 0.0, -0.9950041770935059, 0.0998334139585495, 0.0, -0.17391304671764374, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.9784782528877258, 0.1491304337978363, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [0.25121650099754333, -0.666495144367218, -0.180419921875, 0.0, -0.9950041770935059, 0.0998334139585495, -1.0, 0.32608696818351746, -0.9289000034332275, 0.14628571271896362, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, 0.19304348528385162, 0.6126086711883545, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [0.6857365369796753, 0.22235040366649628, 0.4069512188434601, 1.0, 0.0, 0.0, 0.0, 0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -0.800000011920929, -0.8999999761581421, -1.0, -0.6666666865348816, -0.18760868906974792, 0.18760868906974792, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [0.6857365369796753, 0.5988622307777405, 0.4405384063720703, 0.0, 0.9950041770935059, 0.0998334139585495, 0.0, 0.17391304671764374, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.1491304337978363, 0.9784782528877258, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [0.25121650099754333, 0.6689382791519165, -0.180419921875, 0.0, 0.9950041770935059, 0.0998334139585495, -1.0, -0.32608696818351746, -0.9289000034332275, 0.14628571271896362, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.6126086711883545, -0.19304348528385162, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.3840920031070709, -0.21990728378295898, 0.4069512188434601, -1.0, 0.0, 0.0, 0.0, 0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -0.800000011920929, -0.8999999761581421, -1.0, -0.6666666865348816, -0.18760868906974792, 0.18760868906974792, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.3840920031070709, -0.5964191555976868, 0.4405384063720703, 0.0, -0.9950041770935059, 0.0998334139585495, 0.0, -0.21739129722118378, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.9784782528877258, 0.1491304337978363, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.8937914371490479, -0.6507636904716492, -0.04102034121751785, 0.0, -0.9950041770935059, 0.0998334139585495, -1.0, 0.32608696818351746, -0.9289000034332275, 0.14628571271896362, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, 0.19304348528385162, 0.6126086711883545, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.3840920031070709, 0.22235040366649628, 0.4069512188434601, -1.0, 0.0, 0.0, 0.0, -0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -0.800000011920929, -0.8999999761581421, -1.0, -0.6666666865348816, -0.18760868906974792, 0.18760868906974792, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.3840920031070709, 0.5988622307777405, 0.4405384063720703, 0.0, 0.9950041770935059, 0.0998334139585495, 0.0, 0.21739129722118378, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.1491304337978363, 0.9784782528877258, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.8937914371490479, 0.6532068252563477, -0.04102034121751785, 0.0, 0.9950041770935059, 0.0998334139585495, -1.0, -0.32608696818351746, -0.9289000034332275, 0.14628571271896362, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.6126086711883545, -0.19304348528385162, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312]],
			[12, 23]
		);
		this.dynamic_foot_description = tf.tensor2d(
			[[0.6414347887039185, -0.7434242963790894, -0.8621057868003845, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [0.6414347887039185, 0.7458674311637878, -0.8621057868003845, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.603391706943512, -0.739032506942749, -0.8231890797615051, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312], [-0.603391706943512, 0.7414756417274475, -0.8231890797615051, -0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312]],
			[4, 10]
		);
		this.general_policy_state_second_part = new Float32Array(
			[-0.6000000238418579, -0.5, -0.375, -0.8500770926475525, -0.29670971632003784, -0.5771695971488953, -0.5244216918945312],
		);
		this.p_gain = 20.0;
		this.d_gain = 0.5;
		this.scaling_factor = 0.25;
		this.joint_mask_qpos = new Float32Array([7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18])
		this.joint_mask_qvel = new Float32Array([6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17])
		this.foot_indices = [19, 31, 43, 55];
		this.foot_contact_threshold = 0.01725;
	}
}

class UnitreeGo2 extends RobotActionHandler {
	constructor() {
		super();
		this.dynamic_joint_description = tf.tensor2d(
			[[0.6052801012992859, 0.2154567390680313, 0.401143878698349, 1.0, 0.0, 0.0, 0.0, 0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.2276521772146225, 0.2276521772146225, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [0.6052801012992859, 0.6472293138504028, 0.4412548243999481, 0.0, 0.9950041770935059, 0.0998334139585495, 0.0, 0.17391304671764374, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.34147825837135315, 0.7588478326797485, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [0.19986966252326965, 0.7145475149154663, -0.17995460331439972, 0.0, 0.9950041770935059, 0.0998334139585495, -1.0, -0.32608696818351746, -0.9091399908065796, -0.10285714268684387, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.5918912887573242, -0.18212173879146576, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [0.6052801012992859, -0.20712405443191528, 0.401143878698349, 1.0, 0.0, 0.0, 0.0, -0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.2276521772146225, 0.2276521772146225, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [0.6052801012992859, -0.638896644115448, 0.4412548243999481, 0.0, -0.9950041770935059, 0.0998334139585495, 0.0, -0.17391304671764374, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.7588478326797485, 0.34147825837135315, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [0.19986966252326965, -0.7062148451805115, -0.17995460331439972, 0.0, -0.9950041770935059, 0.0998334139585495, -1.0, 0.32608696818351746, -0.9091399908065796, -0.10285714268684387, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, 0.18212173879146576, 0.5918912887573242, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.4210026264190674, 0.2154567390680313, 0.401143878698349, -1.0, 0.0, 0.0, 0.0, -0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.2276521772146225, 0.2276521772146225, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.4210026264190674, 0.6472293138504028, 0.4412548243999481, 0.0, 0.9950041770935059, 0.0998334139585495, 0.0, 0.21739129722118378, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.11382608860731125, 0.9865000247955322, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.89655601978302, 0.6994351744651794, -0.04049866273999214, 0.0, 0.9950041770935059, 0.0998334139585495, -1.0, -0.32608696818351746, -0.9091399908065796, -0.10285714268684387, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.5918912887573242, -0.18212173879146576, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.4210026264190674, -0.20712405443191528, 0.401143878698349, -1.0, 0.0, 0.0, 0.0, 0.021739130839705467, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.2276521772146225, 0.2276521772146225, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.4210026264190674, -0.638896644115448, 0.4412548243999481, 0.0, -0.9950041770935059, 0.0998334139585495, 0.0, -0.21739129722118378, -0.9526000022888184, 0.7200000286102295, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, -0.9865000247955322, 0.11382608860731125, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.89655601978302, -0.6911025047302246, -0.04049866273999214, 0.0, -0.9950041770935059, 0.0998334139585495, -1.0, 0.32608696818351746, -0.9091399908065796, -0.10285714268684387, -1.0, -0.8999999761581421, -1.0, -0.6666666865348816, 0.18212173879146576, 0.5918912887573242, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319]] ,
			[12, 23]
		);
		this.dynamic_foot_description = tf.tensor2d(
			[[0.5598876476287842, 0.7890336513519287, -0.8673096299171448, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [0.5598876476287842, -0.7807009816169739, -0.8673096299171448, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.630267858505249, 0.7846651673316956, -0.8269975185394287, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319], [-0.630267858505249, -0.7763324975967407, -0.8269975185394287, -0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319]] ,
			[4, 10]
		);
		this.general_policy_state_second_part = new Float32Array(
			[-0.6000000238418579, -0.5, -0.25, -0.8211010694503784, -0.24621161818504333, -0.5598474740982056, -0.5246139168739319] ,
		);
		this.p_gain = 20.0;
		this.d_gain = 0.5;
		this.scaling_factor = 0.3;
		this.joint_mask_qpos = new Float32Array([7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18])
		this.joint_mask_qvel = new Float32Array([6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17])
		this.foot_indices = [20, 32, 44, 56];
		this.foot_contact_threshold = 0.0165;
	}
}

class ANYboticsANYmalB extends RobotActionHandler {
	constructor() {
		super();
		this.dynamic_joint_description = tf.tensor2d(
			[[0.457264244556427, 0.2864508628845215, 0.10354644805192947, 1.0, 0.0, 0.0, 0.0, 0.0, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [0.5620883703231812, 0.38769641518592834, 0.10354644805192947, 0.0, 1.0, 0.0, 0.0, 0.08695652335882187, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [0.40137797594070435, 0.656861424446106, -0.23356333374977112, 0.0, 1.0, 0.0, -1.0, -0.17391304671764374, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [0.457264244556427, -0.2864508628845215, 0.10354644805192947, 1.0, 0.0, 0.0, 0.0, 0.0, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [0.5620883703231812, -0.38769641518592834, 0.10354644805192947, 0.0, -1.0, 0.0, 0.0, -0.08695652335882187, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [0.40137797594070435, -0.656861424446106, -0.23356333374977112, 0.0, -1.0, 0.0, -1.0, 0.17391304671764374, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.457264244556427, 0.2864508628845215, 0.10354644805192947, -1.0, 0.0, 0.0, 0.0, 0.0, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.5620883703231812, 0.38769641518592834, 0.10354644805192947, 0.0, 1.0, 0.0, 0.0, -0.08695652335882187, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.40137797594070435, 0.656861424446106, -0.23356333374977112, 0.0, 1.0, 0.0, -1.0, 0.17391304671764374, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.457264244556427, -0.2864508628845215, 0.10354644805192947, -1.0, 0.0, 0.0, 0.0, 0.0, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.5620883703231812, -0.38769641518592834, 0.10354644805192947, 0.0, -1.0, 0.0, 0.0, 0.08695652335882187, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.40137797594070435, -0.656861424446106, -0.23356333374977112, 0.0, -1.0, 0.0, -1.0, -0.17391304671764374, -0.9200000166893005, -0.1428571492433548, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191]] ,
			[12, 23]
		);
		this.dynamic_foot_description = tf.tensor2d(
			[[0.7449910044670105, 0.6074733734130859, -0.5783870816230774, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [0.7449910044670105, -0.6074733734130859, -0.5783870816230774, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.7449910044670105, 0.6074733734130859, -0.5783870816230774, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191], [-0.7449910044670105, -0.6074733734130859, -0.5783870816230774, 0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191]] ,
			[4, 10]
		);
		this.general_policy_state_second_part = new Float32Array(
			[0.6000000238418579, 1.0, 0.25, -0.6078758835792542, 0.21155333518981934, -0.1900879442691803, 0.3661143183708191] ,
		);
		this.p_gain = 80.0;
		this.d_gain = 2.0;
		this.scaling_factor = 0.5;
		this.joint_mask_qpos = new Float32Array([7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18])
		this.joint_mask_qvel = new Float32Array([6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17])
		this.foot_indices = [45, 74, 103, 132];
		this.foot_contact_threshold = 0.02325;
	}
}

class ANYboticsANYmalC extends RobotActionHandler {
	constructor() {
		super();
		this.dynamic_joint_description = tf.tensor2d(
			[[0.5518326163291931, 0.23507483303546906, 0.36857977509498596, 1.0, 0.0, 0.0, 0.0, 0.0, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.156521737575531, 0.10652174055576324, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [0.6620519161224365, 0.4245135188102722, 0.36857977509498596, 2.220446049250313e-16, 1.0, 7.732659810244513e-07, 0.0, 0.08695652335882187, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [0.45783478021621704, 0.6512255668640137, -0.20870843529701233, 3.3306690738754696e-16, 1.0, 7.732659810244513e-07, -1.0, -0.17391304671764374, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [0.5518326163291931, -0.23507483303546906, 0.36857977509498596, 1.0, 0.0, 0.0, 0.0, 0.0, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.10652174055576324, 0.156521737575531, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [0.6620519161224365, -0.4245135188102722, 0.36857977509498596, 2.220446049250313e-16, -1.0, 7.732659810244513e-07, 0.0, -0.08695652335882187, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [0.45783478021621704, -0.6512255668640137, -0.20870843529701233, 3.3306690738754696e-16, -1.0, 7.732659810244513e-07, -1.0, 0.17391304671764374, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.5518326163291931, 0.23507483303546906, 0.36857977509498596, -1.0, 0.0, 0.0, 0.0, 0.0, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.10652174055576324, 0.156521737575531, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.6620519161224365, 0.4245135188102722, 0.36857977509498596, 2.220446049250313e-16, 1.0, 7.732659810244513e-07, 0.0, -0.08695652335882187, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.45783478021621704, 0.6512255668640137, -0.20870843529701233, 2.220446049250313e-16, 1.0, 7.732659810244513e-07, -1.0, 0.17391304671764374, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.5518326163291931, -0.23507483303546906, 0.36857977509498596, -1.0, 0.0, 0.0, 0.0, 0.0, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.156521737575531, 0.10652174055576324, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.6620519161224365, -0.4245135188102722, 0.36857977509498596, 2.220446049250313e-16, -1.0, 7.732659810244513e-07, 0.0, 0.08695652335882187, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.45783478021621704, -0.6512255668640137, -0.20870843529701233, 2.220446049250313e-16, -1.0, 7.732659810244513e-07, -1.0, -0.17391304671764374, -0.8399999737739563, -0.5714285969734192, -0.800000011920929, -1.0, -1.0, -0.8333333134651184, -0.6826087236404419, 0.6826087236404419, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413]] ,
			[12, 23]
		);
		this.dynamic_foot_description = tf.tensor2d(
			[[0.8329432010650635, 0.6807233691215515, -0.7723957896232605, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [0.8329432010650635, -0.6807233691215515, -0.7723957896232605, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.8329432010650635, 0.6807233691215515, -0.7723957896232605, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413], [-0.8329432010650635, -0.6807233691215515, -0.7723957896232605, 0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413]] ,
			[4, 10]
		);
		this.general_policy_state_second_part = new Float32Array(
			[0.6000000238418579, 1.0, 0.25, -0.4709978699684143, 0.08692382276058197, -0.11517537385225296, -0.09056761115789413] ,
		);
		this.p_gain = 80.0;
		this.d_gain = 2.0;
		this.scaling_factor = 0.5;
		this.joint_mask_qpos = new Float32Array([7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18])
		this.joint_mask_qvel = new Float32Array([6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17])
		this.foot_indices = [52, 66, 80, 94];
		this.foot_contact_threshold = 0.0225;
	}
}


export function create_robot_action_handlers() {
    return {
        "unitree_a1/unitree_a1.xml": new UnitreeA1(),
		"unitree_go1/unitree_go1.xml": new UnitreeGo1(),
		"unitree_go2/unitree_go2.xml": new UnitreeGo2(),
		"anybotics_anymal_b/anybotics_anymal_b.xml": new ANYboticsANYmalB(),
		"anybotics_anymal_c/anybotics_anymal_c.xml": new ANYboticsANYmalC(),
    }
}